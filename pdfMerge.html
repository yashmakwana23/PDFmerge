<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Merger</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            margin: 1rem;
        }

        h1 {
            text-align: center;
            color: #007bff;
            margin-top: 0;
        }

        #file-input {
            display: none;
        }

        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .btn {
            border: 2px solid #007bff;
            color: #007bff;
            background-color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .upload-btn-wrapper .btn:hover {
            background-color: #007bff;
            color: white;
        }

        #file-list {
            list-style: none;
            padding: 0;
            margin-bottom: 1.5rem;
            min-height: 50px; /* Provides a drop area even when empty */
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 10px;
        }

        .file-item {
            background-color: #e9ecef;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
            border: 1px solid #ddd;
        }
        
        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-item:grabbing {
            cursor: grabbing;
        }
        
        .sortable-ghost {
            opacity: 0.4;
            background: #cce5ff;
        }


        #merge-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #merge-btn:hover {
            background-color: #218838;
        }

        #merge-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.7;
        }

        #status-message {
            text-align: center;
            margin-top: 1rem;
            font-weight: bold;
            color: #17a2b8;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>PDF Merger</h1>
        <p style="text-align: center; color: #6c757d;">Select your PDF files, drag to reorder them, and click merge.</p>

        <div class="upload-btn-wrapper">
            <button class="btn" onclick="document.getElementById('file-input').click()">Select PDF Files</button>
            <input type="file" id="file-input" accept="application/pdf" multiple>
        </div>

        <ul id="file-list"></ul>

        <button id="merge-btn" class="merge-btn" disabled>Merge PDFs</button>
        <div id="status-message"></div>
    </div>

    <!-- CDN for pdf-lib.js -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <!-- CDN for SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        // DOM Elements
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        const mergeBtn = document.getElementById('merge-btn');
        const statusMessage = document.getElementById('status-message');
        
        // Array to hold the File objects
        let pdfFiles = [];

        // Event listener for file selection
        fileInput.addEventListener('change', (event) => {
            const selectedFiles = Array.from(event.target.files);
            selectedFiles.forEach(file => {
                // Add file only if it's a PDF and not already in the list
                if (file.type === 'application/pdf' && !pdfFiles.some(f => f.name === file.name)) {
                    pdfFiles.push(file);
                }
            });
            renderFileList();
            // Clear the input value to allow selecting the same file again if removed
            fileInput.value = ''; 
        });

        /**
         * Renders the list of selected PDF files in the UI.
         */
        function renderFileList() {
            fileList.innerHTML = ''; // Clear the current list
            if (pdfFiles.length === 0) {
                fileList.innerHTML = '<p style="text-align:center; color:#6c757d;">Drag & drop files here or use the button above.</p>';
            } else {
                pdfFiles.forEach((file, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'file-item';
                    listItem.dataset.index = index; // Store original index
                    listItem.textContent = file.name;
                    fileList.appendChild(listItem);
                });
            }

            // Enable or disable the merge button based on the number of files
            mergeBtn.disabled = pdfFiles.length < 2;
        }

        // Initialize SortableJS on the file list for drag-and-drop reordering
        new Sortable(fileList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: (evt) => {
                // Reorder the pdfFiles array based on the drag-and-drop action
                const movedItem = pdfFiles.splice(evt.oldIndex, 1)[0];
                pdfFiles.splice(evt.newIndex, 0, movedItem);
                // Re-render the list to reflect the new order
                renderFileList(); 
            }
        });

        // Event listener for the merge button click
        mergeBtn.addEventListener('click', async () => {
            if (pdfFiles.length < 2) {
                alert('Please select at least two PDF files to merge.');
                return;
            }

            // Update UI to show merging is in progress
            mergeBtn.disabled = true;
            mergeBtn.textContent = 'Merging...';
            statusMessage.textContent = 'Processing your files...';

            try {
                // Create a new PDF document
                const mergedPdf = await PDFLib.PDFDocument.create();

                // Loop through each selected PDF file
                for (const pdfFile of pdfFiles) {
                    const arrayBuffer = await pdfFile.arrayBuffer();
                    // Load the PDF file into pdf-lib
                    const pdf = await PDFLib.PDFDocument.load(arrayBuffer, { 
                        // Corrupt PDFs can sometimes be loaded by ignoring annotations
                        ignoreEncryption: true 
                    });
                    // Copy all pages from the current PDF to the merged PDF
                    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copiedPages.forEach((page) => {
                        mergedPdf.addPage(page);
                    });
                }

                // Serialize the merged PDF to bytes
                const mergedPdfBytes = await mergedPdf.save();

                // Create a blob and trigger a download
                const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'merged_document.pdf';
                document.body.appendChild(link); // Required for Firefox
                link.click();
                document.body.removeChild(link);
                
                statusMessage.textContent = 'Merge successful! Your download has started.';
                
                // Reset the app state
                pdfFiles = [];
                renderFileList();

            } catch (error) {
                console.error('Error merging PDFs:', error);
                statusMessage.textContent = 'An error occurred. Please check console for details.';
                alert('An error occurred while merging the PDFs. Some files might be corrupt or protected.');
            } finally {
                // Re-enable the merge button and reset its text
                mergeBtn.disabled = pdfFiles.length < 2;
                mergeBtn.textContent = 'Merge PDFs';
                setTimeout(() => { statusMessage.textContent = ''; }, 5000);
            }
        });

        // Initial render
        renderFileList();
    </script>

</body>
</html>